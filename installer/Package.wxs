<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <Package Name="DS Claude Client"
             Manufacturer="DS"
             Version="1.3.0.0"
             UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
             Compressed="yes"
             InstallerVersion="500"
             Scope="perUser">

        <SummaryInformation Description="DS Claude Client - A custom Windows desktop client for Claude AI with WebView2, snippets management, and enhanced features."
                            Manufacturer="DS"
                            Keywords="Claude, AI, Desktop, Client, WebView2" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                      AllowSameVersionUpgrades="yes"
                      Schedule="afterInstallInitialize" />
        <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

        <!-- Add/Remove Programs properties -->
        <Property Id="ARPPRODUCTICON" Value="AppIcon.ico" />
        <Property Id="ARPCOMMENTS" Value="A custom Windows desktop client for Claude AI with enhanced text input, snippets, and message history." />
        <Property Id="ARPHELPLINK" Value="https://github.com/dsodol/DS_ClaudeClient" />
        <Property Id="ARPURLINFOABOUT" Value="https://github.com/dsodol/DS_ClaudeClient" />
        <Property Id="ARPNOREPAIR" Value="1" />

        <!-- Icon for Add/Remove Programs -->
        <Icon Id="AppIcon.ico" SourceFile="..\DS_ClaudeClient\Resources\app.ico" />

        <!-- WiX UI with feature tree for shortcut selection -->
        <ui:WixUI Id="WixUI_FeatureTree" />
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

        <!-- Launch application after install -->
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch DS Claude Client" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
        <Property Id="WixShellExecTarget" Value="[#DS_ClaudeClientExe]" />
        <CustomAction Id="LaunchApplication" DllEntry="WixShellExec" Impersonate="yes" BinaryRef="Wix4UtilCA_X86" />
        <UI>
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
        </UI>

        <!-- Install to LocalAppData for per-user install -->
        <StandardDirectory Id="LocalAppDataFolder">
            <Directory Id="INSTALLFOLDER" Name="DS Claude Client">
                <Directory Id="RuntimesFolder" Name="runtimes">
                    <Directory Id="WinX64Folder" Name="win-x64">
                        <Directory Id="NativeFolder" Name="native" />
                    </Directory>
                </Directory>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="DS Claude Client" />
        </StandardDirectory>

        <StandardDirectory Id="DesktopFolder" />

        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <Component Id="MainExecutable" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567891">
                <File Id="DS_ClaudeClientExe" Source="..\publish\DS_ClaudeClient.exe" KeyPath="yes" />
            </Component>
            <Component Id="MainDll" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567892">
                <File Id="DS_ClaudeClientDll" Source="..\publish\DS_ClaudeClient.dll" />
            </Component>
            <Component Id="DepsJson" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567893">
                <File Id="DepsJson" Source="..\publish\DS_ClaudeClient.deps.json" />
            </Component>
            <Component Id="RuntimeConfig" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567894">
                <File Id="RuntimeConfig" Source="..\publish\DS_ClaudeClient.runtimeconfig.json" />
            </Component>
            <Component Id="WebView2Core" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567895">
                <File Id="WebView2CoreDll" Source="..\publish\Microsoft.Web.WebView2.Core.dll" />
            </Component>
            <Component Id="WebView2WinForms" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567896">
                <File Id="WebView2WinFormsDll" Source="..\publish\Microsoft.Web.WebView2.WinForms.dll" />
            </Component>
            <Component Id="WebView2Wpf" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567897">
                <File Id="WebView2WpfDll" Source="..\publish\Microsoft.Web.WebView2.Wpf.dll" />
            </Component>
            <Component Id="WebView2Loader" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567898">
                <File Id="WebView2LoaderDll" Source="..\publish\WebView2Loader.dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="RuntimeComponents" Directory="NativeFolder">
            <Component Id="WebView2Runtime" Guid="B1B2C3D4-E5F6-7890-ABCD-EF1234567899">
                <File Id="WebView2NativeDll" Source="..\publish\runtimes\win-x64\native\WebView2Loader.dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="ShortcutComponents" Directory="ApplicationProgramsFolder">
            <Component Id="ApplicationShortcut" Guid="B1B2C3D4-E5F6-7890-ABCD-EF123456789A">
                <Shortcut Id="ApplicationStartMenuShortcut"
                          Name="DS Claude Client"
                          Description="Claude AI Desktop Client with enhanced features"
                          Target="[INSTALLFOLDER]DS_ClaudeClient.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="AppIcon.ico" />
                <RemoveFolder Id="CleanUpShortCut" On="uninstall" />
                <RegistryValue Root="HKCU" Key="Software\DS\DS Claude Client" Name="installed" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="DesktopShortcutComponents" Directory="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="B1B2C3D4-E5F6-7890-ABCD-EF123456789B">
                <Shortcut Id="DesktopShortcut"
                          Name="DS Claude Client"
                          Description="Claude AI Desktop Client with enhanced features"
                          Target="[INSTALLFOLDER]DS_ClaudeClient.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="AppIcon.ico" />
                <RegistryValue Root="HKCU" Key="Software\DS\DS Claude Client" Name="desktopShortcut" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- Feature hierarchy with user-selectable options -->
        <Feature Id="ProductFeature"
                 Title="DS Claude Client"
                 Description="Core application files required to run DS Claude Client."
                 Level="1"
                 Display="expand"
                 AllowAbsent="no"
                 AllowAdvertise="no"
                 InstallDefault="local">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentGroupRef Id="RuntimeComponents" />

            <Feature Id="StartMenuShortcut"
                     Title="Start Menu Shortcut"
                     Description="Creates a shortcut in the Windows Start Menu for easy access to DS Claude Client."
                     Level="1"
                     AllowAbsent="yes"
                     AllowAdvertise="no"
                     InstallDefault="local">
                <ComponentGroupRef Id="ShortcutComponents" />
            </Feature>

            <Feature Id="DesktopShortcut"
                     Title="Desktop Shortcut"
                     Description="Creates a shortcut on your Desktop for quick access to DS Claude Client."
                     Level="1"
                     AllowAbsent="yes"
                     AllowAdvertise="no"
                     InstallDefault="local">
                <ComponentGroupRef Id="DesktopShortcutComponents" />
            </Feature>
        </Feature>
    </Package>
</Wix>
